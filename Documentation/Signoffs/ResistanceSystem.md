# Team 4 – Mario Kart & Ride Replay Simulator

Team Members: Ray Durlin, Blake Pickett, Tyler Chittum, Benjamin Reed, and Sage Mooneyham

## Detail Design: Resistance System ##


_Function of the Subsystem:_ 

The function of the resistance system is to control and vary the resistance felt by the user of the simulator. The resistance system contains an H-Bridge microcontroller that receives a wirelessly input resistance level value from the RRS processing subsystem in the form of a numbered value ranging from 0 to 85. The H-bridge supplies either a positive or negative voltage to the linear actuator to control the direction of the actuator's motion, and the on-board microcontroller controls the duty cycle of the applied voltage to modulate speed. The microcontroller takes an analog input from the linear actuator to determine its current position, as well as an external digital input (via the Bluetooth module) to determine the calculated set point which the actuator should try to reach. The linear motor is attached to an array of N52 neodymium magnets. The linear motor is to vary the array of magnets perpendicular to the simulator’s rear conductive flywheel. As the magnet array is varied perpendicular to the conductive flywheel, eddy currents are generated by the primary magnetic induction formed at the conductor [1]. As the eddy currents form, braking torque is also generated due to the opposing magnetic field. This torque produced in the flywheel is then transferred to the rear bike wheel. The braking torque functions as the resistance felt by the user. The braking torque ranges from 0 to 28.9 N∙m based on the input resistance level received by the H-Bridge controller. 28.9 N∙m is the greatest amount of torque available given the user is pedaling at the minimum speed.

**_Constraints:_**

_Flywheel Speed:_

•	The minimum flywheel speed required for the resistance system to operate as designed is 9 mph (or 2501.6 flywheel RPM). At flywheel speeds less than 2501.6 RPM, the resistance system will be unable to reach the maximum torque specification, but it will be controlled to provide resistance in as much as possible given the decreasing braking torque with decreasing angular velocity. The value of 9 mph is based on the American Council on Exercise's recommendation regarding the minimum speed for moderate exercising [2].

•	The maximum speed at which the resistance system will operate is pedal 118 rpm (or 6190.3 Flywheel RPM). The maximum speed is determined based on a cyclist traveling at an elite level [3]. When the flywheel is spinning faster than 6190.3 RPM, the resistance system will minimize braking torque to the flywheel to avoid any injury to the rider.

_Flywheel Weight:_

The flywheel construct is required to weigh 20 pounds. The specified flywheel weight is based on data provided by the bike academy that states many indoor cyclists avoid exercise bikes with flywheels over 20 pounds due to the heavier flywheel making it more difficult to generate a desirable momentum [4].

_Resistance States:_

Based on a study conducted by Romagnoli and Piacentini [5], it was found that test subjects could accurately perceive differences in exercise velocity, and in turn resistance changes, approximately 80% of the time, meaning they were inaccurate 20% of the time. However, there is no published documentation that has determined the exact human threshold a human can sense changes in resistance. Using half of the 20% value, a MATLAB script was created to determine what angles resulted in 10% ± 5% increases in resistance. This resulted in 85 unique states. Because of this, the resistance system shall have no less than 85 states of resistance. 

_Maximum Produced Torque:_

Based on a study conducted by R C Haut [6], the force required to fracture the patella or femur is approximately 8.5 kN. Applying the gear ratio of the Mario Kart bike and the radius of its wheel, we come to a torque of 4748.94 Nm (torque = gear ratio * wheel radius * force) required to fracture these leg bones. Creating an upper limit of 10% of this value, we get an upper limit torque of 474.89 Nm. Our produced torque utilizing the eddy current braking system shall not exceed this value to protect the user from bodily harm from changes in resistance.

**_Buildable schematic:_**

_Resistance System:_

![image](https://user-images.githubusercontent.com/114370750/204955948-41f69d9c-ff85-43b6-aaa1-f8d9cf343a95.png)

Figure 1. 3D Model Of Flywheel, Magnet, and Bracket

![image](https://user-images.githubusercontent.com/114370750/204956305-c4b9ecdb-e11f-4258-981c-f0aa6780823b.png)

Figure 2. Magnet Dimensions

![image](https://user-images.githubusercontent.com/114370750/204956402-5a1c328c-9039-4abf-8c40-277091f3db32.png)

Figure 3. Flywheel Dimensions

![image](https://user-images.githubusercontent.com/114370750/204956463-ca256803-743d-4289-af42-5ac5a970c525.png)

Figure 4. Bracket Dimensions


**_Analysis:_**


![image](https://user-images.githubusercontent.com/114370750/204956675-6d7fa65d-db1f-4119-a871-743fb1f624a9.png)

Figure 5. Torque Seen by Rider at 2501.6 Flywheel RPM

![image](https://user-images.githubusercontent.com/114370750/204956869-adccd82d-d41e-400a-b9cc-2f6999196d0e.png)

Figure 6. Torque at Wheel at the 2501.6 Flywheel RPM

The plots in Figures 5 and 6 above represent the braking torque applied to the flywheel and the braking torque felt by the rider, as the rider is traveling the minimum speed of 2501.6 RPM, while the distance or air gap between the magnets and flywheel vary from 200 mm to 40 mm apart. The plots above are intended to prove that the resistance system can provide sufficient braking torque while operating at the minimum speed. 
The resistance system is centered around the electromagnetic topic of eddy currents and Lenz’s Law. An equation found in a publication for the Centre for Intelligent Machines that models the function of an eddy current braking system was utilized to determine the attributes of the resistance system components [1]. Specifically, the torque achieved depends on angular speed, as well as magnet distance from the flywheel. Specifically, the function used is shown below,

![image](https://user-images.githubusercontent.com/114370750/204959163-285ab200-000b-4692-9e6f-c6ece26a7dcf.png)


where,

σ = Conductivity of flywheel material  (Ω^(-1) m^(-1) )

D=magnet diameter (meters)

d = disc (flywheel) thickness (meters)

B = magnet field strength (Tesla)

R = dist from flywheel center to magnet (m) 

θ = angular velocity (rads/s)

Using this equation, we can determine the torque produced in the flywheel at varying magnet distances, as well as varying angular speeds. The other variables are constant in this design. The braking torque felt by the rider is calculated using the diameter ratio between the flywheel and bike wheel, as well as the gear ratio between the rear and front sprocket (pedal sprocket). The torque threshold that needed to be met was approximately 30 Nm. This was determined by using the maximum power output for the system, 300 W, divided by a quarter of the maximum angular velocity for the system (described below), resulting in a velocity of 10.15 rad/s. The purpose of this analysis was to determine the attributes that would reach that 30 Nm threshold. 
The following values were able to be determined from the onset.

•	The bicycle’s wheel radius is a known constant of 0.33 m. 

•	The flywheel’s radius is a known constant of 0.1016 m.

•	The flywheel’s thickness is a known constant of 0.0127 m.

•	The magnet’s diameter is a known constant of 0.0508 m.

•	The material for the flywheel was determined to be aluminum. This is because aluminum has the highest conductivity for the cost, allowing the resistance system to reach the necessary torque values. Therefore, this value is 3.77*107 (Ωm)-1.

•	The axis-to-pole value was set to be approximately 0.305 m. This distance was determined by the flywheel’s radius minus the maximum radius of the magnet options available. It should also be noted that torque is maximized when the magnets are at the edge of the flywheel.

The attributes left to be determined were the magnetic field and the angular speed. The magnetic field and angular speed can be considered as the varying components in torque calculation. The angular speed will always be changing, and its values will determine the field strength needed to produce certain torque states. Using a linear actuator, we can increase or decrease the distance from the aluminum flywheel to the magnet, causing an increase or decrease in the magnetic field the flywheel experiences. This relationship can be modeled using an equation from K&J Magnetics website [7].


![image](https://user-images.githubusercontent.com/114370750/204959326-d84dcacf-5538-4978-9895-941e10c926c8.png)



Note: Field strength in the y direction

where,

μ_o=magnetic permeability in a vaccum (Tm/A)

m = magnetic moment (Am^2 )

r=dist. from magnet to flywheel (m)

Because the x-component of the point of measurement on the flywheel is zero, the total magnetic field at the flywheel is equal to the y-component of the magnetic field. Magnetic moment of the magnet can be found using another equation on K&J Magnetics website.


![image](https://user-images.githubusercontent.com/114370750/204959408-ff204d1e-5683-4978-9026-2c1e501ef837.png)

   
where, 

B_(r )= residual field (Gauss)

V = magnet volume (m^3 )

The magnets used within the resistance system were chosen for the resistance system are the DY04-N52, from K&J Magnetics [7]. The resistance system is intended to have two magnets that are each 2 inches in diameter by 0.25 inches in thickness. This magnet was chosen based on several factors. The optimal shape of the magnet was found to be a disk shape. The disk shape allowed the team to apply Lenz’s formula without further adaptation. Also, the DY04-N52 magnets have a surface field of 1795 Gauss, which is proven to be the ideal field strength given the data in Figures 5 and 6.

With the magnet selected, we could now see how the field drops as distance from magnet to flywheel increases. The residual field is given to be 14,800 Gauss, and its volume is calculated to be 1.287E-5 m^3. This gives a magnetic moment of 15.158 Am^2. The distance of air gap between the magnets and the flywheel will be calculated by the RSS processing subsystem and is an external input to the resistance subsystem.


Table 1: An Analysis of Selected Control Circuit Components and Relevant Design Considerations.

| **Component(s)**                            | **Design Considerations**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Switching Transistors (Q1, Q2, Q3, Q4)      | Q1 and Q2 are rated to handle continuous current up to 24 A, while Q3 and Q4 are rated to handle continuous current up to 45 A; both are well above the expected current requirement. Q1 and Q2 only need to switch when the actuator changes direction, and a delay can be programmatically implemented to ensure no current flows during the switching of these transistors. However, Q3 and Q4 must be able to switch fast enough to handle Pulse Width Modulation (PWM). These FETs have rise and fall times in the order of tens of nanoseconds. As such, they should be easily capable of handling a PWM signal in the kHz range. |
| Back-EMF Protection Diodes (D1, D2, D3, D4) | These diodes are Schottky diodes with fast switching time and very low forward voltage. Compared to the body diodes of the utilized transistors (Vf ~ 1 V), these diodes provide a forward voltage of equal to or less than 0.5 V, effectively bypassing the transistors during reverse-conduction. These diodes are specified for use in free-wheeling applications in the datasheet and are well-suited to handle the large momentary current spikes produced by back-EMF, given that they are rated to handle 100 A peak current.                                                                                                    |
| Resistors (All)                             | All resistors in this circuit were subject to only very small power dissipations; in all cases, less than a milliwatt. As such, small, common ¼ W resistors were selected. Gate resistors were selected to be surface mount chip-resistors to minimize space usage. The gate driver resistors for the P-Ch FETs are larger than those for the N-Ch FETs, as switching speed is not a priority for the P-Ch FETs. The PWM will be done on the N-Ch FETs, and it is vital that the voltage drop across the gate driver IC be minimized to ensure complete biasing at steady-state.                                                        |
| Pre-Biased Dual NPN IC (U1)                 | This component is used to bias the gates of the P-Ch FETs, as turning these transistors off will require a voltage of 12 V – a voltage not achievable by using the microcontroller alone. This component was selected because it combines the utility of four resistors and two BJTs into a single package.                                                                                                                                                                                                                                                                                                                             |
| Arduino Nano (A1)                           | This microcontroller module was selected because it is already in our stock. It provides an on-board voltage regulator capable of regulating to 3.3 V. It is ideal for powering the selected wireless module, and to 5 V, ideal for providing a logic-voltage reference to the linear actuator feedback.                                                                                                                                                                                                                                                                                                                                |
| Bluetooth Module                            | The HC06 module is an incredibly cheap Bluetooth module. It should be capable of providing the required range, as it has a maximum range of about 10 m. In addition to being inexpensive, this module also has the benefit of being very easily connected; it requires only four pins to be connected to the external circuit.                                                                                                                                                                                                                                                                                                          |
| Power Connector                             | The component handles the power input to the circuit, which is then fed into the linear actuator. As such, it must be rated to handle several amperes of current. An XT30 connector was selected, as this type is rated for 15 A which is well over the expected current demand, and it does not allow the user to connect the polarity incorrectly. In addition, the mating connector is commonly available in a form that lends itself to the easy fabrication of cables of a custom length without any special equipment.                                                                                                            |

**_BOM:_**

| Team 4 - Mario Kart & RRS |                 | Bill of Materials   (BOM)                         |               |                  |     |        |           |         |
|:-------------------------:|:---------------:|---------------------------------------------------|---------------|------------------|-----|--------|-----------|---------|
|                           |                 |                                                   |               |                  |     |        |           |         |
|                           |                 |                                                   |               |                  |     |        |           |         |
| Subsystem Name:           |                 |                 Resistance System                 |               |                  |     |        |           |         |
| Requested by:             |                 | Ray D, Blake P, Tyler C,   Benjamin R, and Sage M |               |                  |     |        |           |         |
| Approve by:               |                 |                                                   |               |                  |     |        |           |         |
| Total Cost:               |                 |                      $388.03                      |               |                  |     |        |           |         |
|                           |                 |                                                   |               |                  |     |        |           |         |
|                           |                 |                                                   |               |                  |     |        |           |         |
|           Level           |      Part #     |                     Part Name                     |    Supplier   |  Supplier Part # | Qty |  Units | Unit Cost |   Cost  |
| 1                         |      RS100      |                      Assembly                     |      None     |       None       |  1  |  Assy  |   $0.00   |  $0.00  |
|            1.1            |   ALUMPLATE100  |          Aluminum Plate   10" X10"X 0.5"          | Online Metals |       4535       |  1  |  Sheet |   $70.32  |  $70.32 |
| 2                         |    HBRIDGE100   |                      Assembly                     |      None     |       None       |  1  |  Assy  |   $0.00   |  $0.00  |
|            2.1            |     SOCK100     |                 DC Connector -Male                |      TME      |     XT30PW-M     |  1  |  Piece |   $0.63   |  $0.63  |
|            2.2            |    MOSFET100    |                       MOSFET                      |    DIGIKEY    |      G26P04K     |  2  |  Piece |   $0.78   |  $1.56  |
|            2.3            |    MOSFET101    |                       MOSFET                      |    DIGIKEY    |      AOD424      |  2  |  Piece |   $0.98   |  $1.96  |
|            2.4            |    WIFIREC100   |                Bluetooth Receiveer                |   ALIEXPRESS  |       HC-06      |  1  |  Piece |   $2.24   |  $2.24  |
|            2.5            |     DIODE100    |                       Diode                       |    DIGIKEY    |     B320-13-F    |  4  |  Piece |   $0.48   |  $1.92  |
|            2.6            |      BJT100     |                        BJT                        |    DIGIKEY    |   DDC114YU-7-F   |  1  |  Piece |   $0.43   |  $0.43  |
|            2.7            |   CHRESIST100   |                   Chip Resistor                   |    DIGIKEY    | CRCW120610K0JNEA |  2  |  Piece |   $0.10   |  $0.20  |
|            2.8            |   CHRESIST101   |                   Chip Resistor                   |    DIGIKEY    |   ERJ-8GEYJ102V  |  2  |  Piece |   $0.14   |  $0.28  |
|            2.9            |  CARBRESIST100  |                    1k Resistor                    |    DIGIKEY    |  CFR-25JB-52-1K  |  3  |  Piece |   $0.01   |  $0.03  |
|            2.10           |  CARBRESIST101  |                   2.2k Resistor                   |    DIGIKEY    |  CFR-25JR-52-2K2 |  1  |  Piece |   $0.01   |  $0.01  |
|            2.11           |    ARDNANO100   |                    Arduino Nano                   |    Arduino    |      A000005     |  1  |  Piece |   $24.90  |  $24.90 |
| 3                         |  LINMOTORBRK100 |                      Assembly                     |      None     |       None       |  1  |  Assy  |   $0.00   |  $0.00  |
|            3.1            |     STLSH100    |              12" X 18"   Steel sheet              |     Lowes     |       44487      |  1  |  Stick |   $9.48   |  $9.48  |
|            3.2            |    STLROD100    |                3/8"X3' Steel   Rod                |     Lowes     |       44079      |  1  |  Stick |   $7.48   |  $7.48  |
|            3.3            |     BOLT100     |                        Bolt                       |     Lowes     |       61820      |  8  |  Piece |   $0.15   |  $1.20  |
|            3.4            |     WASH100     |                       Washer                      |     Lowes     |       63306      |  8  |  Piece |   $0.15   |  $1.20  |
|            3.5            |      NUT100     |                        Nut                        |     Lowes     |       63301      |  8  |  Piece |   $0.10   |  $0.80  |
| 4                         | LINMOTORASSY100 |                      Assembly                     |      None     |       None       |  1  |  Assy  |   $0.00   |  $0.00  |
|            4.1            |   LINMOTOR100   |                    Linear Motor                   |     Pololu    |       4953       |  1  |  Piece |  $183.95  | $183.95 |
|            4.2            |      MG100      |           Magnet - 2" by 0.125" Thickness         |  kjmagnetics  |     DY04-N52     |  2  |  Piece |   $28.44  |  $56.88 |
|            4.3            |      ADH100     |                      Adhesive                     |     Lowes     |       50112      |  1  | Bottle |   $7.98   |  $7.98  |
|            4.4            |   STLFLTBAR100  |                  Flat Bar - Steel                 |     Lowes     |      216190      |  1  |  Stick |   $12.98  |  $12.98 |
|            4.5            |     BOLT100     |                        Bolt                       |     Lowes     |       61820      |  4  |  Piece |   $0.15   |  $0.60  |
|            4.6            |     WASH100     |                       Washer                      |     Lowes     |       63306      |  4  |  Piece |   $0.15   |  $0.60  |
|            4.7            |      NUT100     |                        Nut                        |     Lowes     |       63301      |  4  |  Piece |   $0.10   |  $0.40  |
|                           |                 |                                                   |               |                  |     |        |           |  $0.00  |
|                           |                 |                                                   |               |                  |     |        |           |  $0.00  |
|                           |                 |                                                   |               |                  |     |        |           |  $0.00  |
|                           |                 |                                                   |               |                  |     |        |   Total   | $388.03 |


**REFERENCES**

[1]	A. H. C. Gosline and V. Hayward, "Eddy Current Brakes for Haptic Interfaces: Design, 	Identification, and Control," in IEEE/ASME Transactions on Mechatronics, vol. 13, no. 	6, pp. 669-677, Dec. 2008, doi: 10.1109/TMECH.2008.2004623.

[2]	“How to Start an Exercise Program,” American Council on Exercise, vol. FF, 2013. 

[3]	R. Gregor and L. Childers, “4,” in Neuromechanics of the Cycling Task, Blackwell 	Publishing Ltd, 2011, pp. 52–77.

[4]	D. B, “What is the best flywheel weight for a spin bike,” Exercise Bike Academy, 18-	Apr-2022. [Online]. Available: https://exercisebikeacademy.com/guides/what-is-the-best-	flywheel-weight-for-a-spin-bike/. [Accessed: 20-Nov-2022].

[5]	R. Romagnoli and M. F. Piacentini, “Perception of Velocity during FreeWeight 		Exercises: Difference between Back Squat and Bench Press,” Journal of Functional 	Morphology and Kinesiology, 18-Apr-2022. [Online]. Available: 				https://doi.org/10.3390/jfmk7020034

