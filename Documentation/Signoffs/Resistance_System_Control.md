Team 4 – Mario Kart & Ride Replay Simulator

Team Members: Ray Durlin, Blake Pickett, Tyler Chittum, Benjamin Reed, and Sage Mooneyham

## Detail Design: Resistance System Control Circuit ##

Please note: the scope of this signoff extends only to the control cicuit itself, not to housing components or connectors. Also, the signoff document for the resistance system contains BOM listings and information redundant to this document.

### Function of the Subsystem:

- This subsytem acts to control the linear actuator used in the ride resistance system.
- Controls both the direction and speed of the linear actuator.
- Takes an input from the ride replay subsystem over a wireless connection, which determines the distance set point for the linear actuator.
- Takes an input from the linear actuator feedback to determine the current position of the actuator.

### Constraints:

#### Actuator Duty Cycle

The duty cycle of the utilized linear actuator is 25 %. This value must not be exeeded during normal operation. As a result, the controller must be programmable so that the duty cycle may be limited.

#### Actuator Driving Voltage

The utilized actuator is rated for operation at 12 VDC. The control circuit must be capable of providing this voltage to the actuator during operation, so the absolute value of the voltage across the actuator while the system is in either of the two possible on states (foreward and reverse) shall be constrained to 12 V +/- 1 %, assuming the power subsystem provides an input voltage regulated to 12 VDC.

#### Current Capability

The utilized actuator draws a stall current of 7 A, and has a nominal current draw from 1.1 A to 3.4 A. The control circuit must be capable of handling a motor stall without undergoing thermal overload. In addition, the utilized power connector must be capable of handling the total current demand.

#### Wireless Communications

The control ciruit must be capable of recieving a wirelessly-transmitted digital signal from the ride replay system using Bluetooth to update the actuator's position. Since human reaction time is limited to between 100 and 200 ms [1], it follows that the period of data transmission for each packet containing a position value be constrained to be less than 100 ms.

#### Back-EMF Protection

In the course of operation, particularly when the motor is switched off suddenly, a transient voltage potential known as back-EMF will be generated by the motor with opposite polarity to its driving voltage. Due to this, the control circuit shall contain freewheeling diodes to shunt the resulting current away from the switching transistors to prevent damage to the transistors.

#### Mountability

The PCB layout must account for the need to mount the circuit within its housing, as such, screw holes shall be included in the PCB design.

#### Stability

The device must operate without becoming unstable.

#### Resolution

The device must be capable of providing at least 85 unique states, or lengths of extension when operating within the specified wheel speed range (from 116 RPM to 288 RPM).

### Schematic and PCB Layout

![Schematic](https://user-images.githubusercontent.com/118228609/219084845-ba84c1c1-090a-4c99-8ec1-f31622ce9223.png)

Figure 1: a schematic for the control circuit.

![pcb](https://user-images.githubusercontent.com/118228609/219084784-bf4d30a6-fd0f-44c5-91ad-07a0ac71d8b5.png)

Figure 2: the PCB layout for the design.

The design files are included within the Electrical subdirectory of the Documentation directory. See links: [schematic](https://github.com/rjdurlin42/mariokartrev_2_team_4/blob/main/Documentation/Electrical/Ride%20Resistance%20System%20Control%20Circuit.png), [pcb](https://github.com/rjdurlin42/mariokartrev_2_team_4/tree/main/Documentation/Electrical/PCB/Sources/Ride%20Resistance%20System%20Control%20Circuit).

### Analysis

#### Actuator Duty Cycle

Arduino PID library contains a function to limit the minimum and maximum PWM duty cycle [2].

Function usage:

     SetOutputLimits(min, max)
     min: the minimum PWM duty cycle
     max: the maximum PWM duty cycle

Where min and max are 8-bit integers, and may be directly-addressed.

The Arduino Nano sets the PWM duty cycle so the maximum PWM cycle may be programatically limited to satisfy the constraint as follows:

     SetOutputLimits(0, 63); //63 is floor[(255)*(25 %)]

Therefore, the constraint is satisfied.

#### Actuator Driving Voltage

     Full load actuator current = 3.4 A @ 12 V
     Linear approximation for motor resistance: Rmotor = 3.529 Ω
     Rds_on(Q1,Q2) = 18 mΩ = 0.018 Ω
     Rds_on(Q3,Q4) = 4.4 mΩ = 0.0044 Ω
     Minimum actuator voltage satisfying constraint = 12 V - 12*0.01 V = 11.88 V

Circuit Analysis:

     On state 1 [Q1 and Q4 on, Q2 and Q3 off]
          |Actuator voltage| = (12 V)*(3.529 Ω)/(3.529 Ω + 0.018 Ω + 0.0044 Ω) = 11.92 V < 11.88 V
     
     On state 2 [Q1 and Q4 off, Q2 and Q3 on]
          |Actuator voltage| = 11.92 V < 11.88 V [by symmetry]

Constraint met.

#### Current Capability

     Linear actuator current at stall = 7 A
     Nominal linear actuator voltage = 12 V
     AMASS XT30 connector current rating = 15 A
     Imax_continuous(Q1,Q2) = 24 A
     Imax_continuous(Q3,Q4) = 45 A
     Stall (worst-case) resistance = (12 V)/(7 A) = 1.714 Ω

By simulation:

     Pd(Q1,Q2) = 1.05 W  < 78 W  = Pmax(Q1,Q2)
     Pd(Q3,Q4) = 0.601 W < 2.5 W = Pmax(Q3,Q4)

Constraint met.

PWM Control Simulation Details:

    Duty Cycle = 25 %
    Switching Frequency = 24 kHz
    Motor Stalled
    Polarity (directional) change at 300 ms
    Switching delay time: 208 to 300 ms
    
![spicesim](https://user-images.githubusercontent.com/118228609/216801981-c4e95213-1aef-4920-8c6b-d191272dd4c3.png)
Figure 3: the LTSPICE schematic prepared for this SPICE simulation.

![loadcurrent](https://user-images.githubusercontent.com/118228609/216802353-ba9df2ad-8ac5-40e6-991e-00e754869501.png)
Figure 4: the load current. The polarity reverses as expected during the simulation of the directional change starting at 300 microseconds. During the high portions of the PWM cycle, the load current is close to the ideal value of 7 A, meaning the H-bridge produces minimal voltage drop.

Note: It is impossible to fully simulate a motor in SPICE without knowing several mechanical characteristics (moment of inertia, coefficient of viscous friction, and torque) [3] and this information is not given by the actuator manufacturer, so a worst-case non-reactive approximation was used. Back-emf simulation impossible for this reason.

#### Wireless Communications

    Ts < 100 ms = 0.1 s
    Distance resolution: 10 bits (limited by microcontroller ADC)
    Communication protocol: serial
    Communication frequency > 1/(0.1 s) = 10 Hz
    Required samples to update distance variable = (10 bits)/(1 bit/sample) = 10 samples
    Required baud rate > (10 Hz)*(10 samples) = 100 Baud < 9600 = HC-06 default baud rate

Contstraint met.

#### Back-EMF Protection

    Vf(D1,D2,D3,D4) = 0.5 V (approximately)
    Vf(Q1,Q2,Q3,Q4) = 1 V (approximately)
    Rated Peak Current(D1,D2,D3,D4) = 100 A

Specified in datasheet for free-wheeling applications such as this; constraint met.

#### Mountability

Four 2.5 mm diameter screw holes have been included in the PCB design (see fig. 2). These screw holes can accommodate #3 screws. Mounting and housing cutouts to be detailed in motor stand signoff.

#### Stability

Arduino programmable as PID controller [4].

Manufacturer-provided PID constants [5]:

    Kp = 1.80
    Ki = 0.0900
    Kd = 2.50

The above can reasonably be assumed to produce a stable system; therefore, constraint met.

#### Resolution

    Full actuator range = 50.04 mm

Please note: the above value is **not the usable range**, but the full range of the actuator itself; it is stated to clarify the analysis which follows.

    Tmax(max speed) = 121.8499 N•m
    Tmin(max speed) = 0.2712 N•m
    Tmax(min speed) = 28.901 N•m
    Tmin(max speed) = 0.0643 N•m
    See tables 1 and 2 in the resistance system signoff for full specified torque ranges
    Precision of controller: 16 bits
    Unique ADC states across full range = 2^16 = 65536
    ADC full scale range: 0 to 6.144 V
    Feedback voltage range: 0 to 5 V
    ADC States across feedback voltage range: floor[65536*(5 V)/(6.144 V) = 53333]
    Distance precision = (50.04 mm)/(65536) = 0.9382 μm

Using a spreadsheet: (see [Controller_Analysis.xlsx](https://github.com/rjdurlin42/mariokartrev_2_team_4/blob/main/Software/Controller_Analysis.xlsx)):

Equation used:

![d_equation](https://user-images.githubusercontent.com/118228609/218931135-f2f4879b-5c32-45da-8440-7ea841859d02.png)

    d:  distance of magnet from flywheel (corresponding to actuator extension lengths)
    Td: developed torque
    ρ:  conductivity
    D:  diameter of magnet
    t:  flywheel thickness
    u0: magnetic permiability of free space
    m:  magnetic dipole moment
    R:  radius of flywheel
    w:  flywheel angular velocity
    Evaluation method: compare the actuation distance required to increment a state at the extrema of the specified 85-state sequences for minimum and maximum speed; compare to determine the smallest distance required to increment a state.
    Result: 10.9 μm
    See EXEL workbook for constant values and formulae
    0.9382 μm < 10.9 μm

Constraint met.


Table 1: miscellaneous component notes and design considerations.
|     Component(s)                                                                            |     Design   Considerations                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|---------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|     Switching Transistors (Q1, Q2, Q3, Q4)                                                  |     Q1 and Q2 only need to switch when the actuator changes direction, and a delay can be programmatically implemented to ensure no current flows during the switching of these transistors. Q3 and Q4 must be able to switch fast enough to handle Pulse Width Modulation (PWM). These FETs have rise and fall times on the order of tens of nanoseconds. As such, they should be capable of handling a PWM signal in the kHz range.                                                                                                                                                |
|     Back-EMF Protection Diodes (D1, D2, D3, D4)                                             |     Compared to the body diodes of the utilized transistors (Vf ~ 1 V), these diodes provide a forward voltage of equal to or less than 0.5 V, effectively bypassing the transistors during reverse-conduction.                                                                                                                                                                                                                                                                                                                                                                      |
|     Resistors (All)                                                                         |     All resistors in this circuit were subject to only very small power dissipations: less than a milliwatt in all cases. As such, small, common ¼ W resistors were selected. Gate resistors were selected to be surface mount chip-resistors to minimize space usage. The gate driver resistors for the P-Ch FETs are larger than those for the N-Ch FETs, as switching speed is not a priority for the P-Ch FETs. The PWM will be done on the N-Ch FETs, and it is vital that the voltage drop across the gate driver IC be minimized to ensure complete biasing at steady-state.  |
|     Pre-Biased Dual NPN IC (U1)                                                             |     This component is used to bias the gates of the P-Ch FETs, as turning these transistors off will require a voltage of 12 V – a voltage not achievable by using the microcontroller alone. This component was selected because it combines the utility of four resistors and two BJTs into a single package.                                                                                                                                                                                                                                                                      |
|     Arduino Nano (A1)                                                                       |     This microcontroller module was selected because it is already in our stock. It provides an on-board voltage regulator capable of regulating to 3.3 V and to 5 V. The 5 V supply is ideal for providing a logic-voltage reference to the linear actuator feedback and powering the HC-06 module. This microcontroller has a 10-bit DAC on board.                                                                                                                                                                                                                                 |
|     Bluetooth Module (MD1)                                                                  |     The HC06 should be capable of providing the required range, as it has a maximum range of about 10 m. In addition to being inexpensive, this module also has the benefit of being very easily connected; it requires only four pins to be connected to the external circuit.                                                                                                                                                                                                                                                                                                      |
|     Power Connector                                                                         |     The component handles the power input to the circuit, which is then fed into the linear actuator. As such, it must be rated to handle slightly over 7 amperes of current. The AMASS XT30 is rated for 15 A. It also does not allow the user to connect the polarity incorrectly and the mating connector is commonly available in a form that lends itself to the easy fabrication of cables of a custom length without any special equipment.                                                                                                                                   |


### Bill of Materials

Table 2: a BOM for the design. Please note that the Arduino Nano is already in our inventory.


|           Level           |      Part #     |                     Part Name                     |    Supplier   |  Supplier Part #       | Qty |  Units | Unit Cost |   Cost  |
| ------------------------- | --------------- | ------------------------------------------------- | ------------- | -----------------------| --- | ------ | --------- | ------- |
| 1                         |    HBRIDGE100   |                      Assembly                     |      None     |         None           |  1  |  Assy  |           |         |
|            1.1            |     SOCK100     |            AMASS XT30 DC Connector - Male         |      TME      |       XT30PW-M         |  1  |  Piece |   $0.63   |  $0.63  |
|            1.2            |    MOSFET100    |              G26P04K P-Channel MOSFET             |    DIGIKEY    |   3141-G26P04KCT-ND    |  2  |  Piece |   $0.78   |  $1.56  |
|            1.3            |    MOSFET101    |               AOD424 N-Channel MOSFET             |    DIGIKEY    |     785-1565-1-ND      |  2  |  Piece |   $0.98   |  $1.96  |
|            1.4            |    WIFIREC100   |             HC-06 Bluetooth Transceiver           |   ALIEXPRESS  |         HC-06          |  1  |  Piece |   $2.24   |  $2.24  |
|            1.5            |     SOCK200     |            Socket Header for Transceiver          |    DIGIKEY    | 2057-SMC-1-04-1-GT-ND  |  1  |  Piece |   $0.33   |  $0.33  |
|            1.6            |     DIODE100    |                 B320 Schottky Diode               |    DIGIKEY    |     B320-FDICT-ND      |  4  |  Piece |   $0.48   |  $1.92  |
|            1.7            |      BJT100     |       DDC114YU-7-F Dual Pre-biased BJT (NPN)      |    DIGIKEY    |   DDC114YU-FDICT-ND    |  1  |  Piece |   $0.43   |  $0.43  |
|            1.8            |   CHRESIST100   |         CRCW120610K0JNEA 10k Chip Resistor        |    DIGIKEY    |     541-10KECT-ND      |  2  |  Piece |   $0.10   |  $0.20  |
|            1.9            |   CHRESIST101   |            ERJ-8GEYJ102V 1k Chip Resistor         |    DIGIKEY    |      P1.0KECT-ND       |  2  |  Piece |   $0.14   |  $0.28  |
|            1.10           |  CARBRESIST100  |            CFR-25JB-52-1K 1k THT Resistor         |    DIGIKEY    |       1.0KQBK-ND       |  3  |  Piece |   $0.10   |  $0.30  |
|            1.11           |  CARBRESIST101  |          CFR-25JB-52-2K2 2.2k THT Resistor        |    DIGIKEY    |    	  2.2KQBK-ND       |  1  |  Piece |   $0.10   |  $0.10  |
|            1.12           |    ARDNANO100   |             Arduino Nano Microcontroller          |    Arduino    |        A000005         |  1  |  Piece |   $24.90  |  $24.90 |
|            1.13           |     SOCK300     |              Socket Header for Arduino            |    DIGIKEY    | 2553-2042-1X15G00SA-ND |  2  |  Piece |   $0.74   |  $1.48  |
|            1.14           |     ADC100      |         ADS1115 4-Channel 16-Bit ADC Module       | Protosupplies | MOD-83                 |  1  |  Board |   $5.95   |  $5.95  |
|            1.15           |     SOCK400     |           Socket Header for ADC Modele            |    DIGIKEY    | 	ED5864-10-ND       |  1  |  Piece |   $2.52   |  $2.52  |
|                           |                 |                                                   |               |                        |     |        |   Total   |  $44.80 |

### Citations

[1]R. Whelan, “Effective analysis of Reaction Time Data,” The Psychological Record, vol. 58, no. 3, pp. 475–482, 2008.

[2]B. Beauregard, "SetOutputLimits()," Arduino Playground. [Online]. Available: https://playground.arduino.cc/Code/PIDLibrarySetOutputLimits/. [Accessed: 10-Feb-2023]

[3]"Using SPICE To Model DC Motors," Precision Microdrives. [Online]. Available: https://www.precisionmicrodrives.com/ab-025. [Accessed: 04-Feb-2023].

[4]B. Beauregard, "Arduino PID Library," Arduino Playground. [Online]. Available: https://playground.arduino.cc/Code/PIDLibrary/. [Accessed: 08-Dec-2022]. 

[5]"Pololu - Glideforce GF23-120502-3-65 high-speed LD linear actuator with feedback: 12kgf, 2’ stroke (1.97’ usable), 3.3’/s, 12V," Pololu Robotics &amp; Electronics. [Online]. Available: https://www.pololu.com/product/4951. [Accessed: 08-Dec-2022]. 
