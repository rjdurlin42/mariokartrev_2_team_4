# Mario Kart Rev 2 - Signoff - Mario Kart Bike Wireless Sensors Subsystem 
## Team 4 - Blake Pickett ##

_Function of the Subsystem:_

The function of the newly designed feature is to convert the speed and steering sensors, the right and left handle bar buttons, and the microcontrollers on the Mario Kart Bike to be wireless. These sensors will gather data, convert it, and send it via Bluetooth to the master microcontroller, the Raspberry Pi (RPi). Each sensor will be given its own microcontroller, an Arduino Nano 33 BLE for both the steering and speed sensor in order to utilize Bluetooth 5 communication to the central RPi. Coding of the individual microcontrollers and their Bluetooth modules will be accomplished through the use of Arduino IDE text editor. This new feature will mitigate safety risks to the Mario Kart Bike riders by eliminating the long wires running down the bike and around the bike stand as well as improve the aesthetic form of the product. These long wires are a safety hazard for future customers. The wires that rectify and step down the power for the sensors on the current version of the Mario Kart Bike will be replaced with a fourth-D-battery holder, complete with four D batteries that will produce 6 V and 6.25 A current to the sensors and microcontrollers. The four D batteries will power the microcontroller, which will power the sensors, for six hours of constant use. 

_Constraints:_ 

The wireless capability provided by the new design requires the removal of the long wires along the bike. Although eliminating the long wires mitigates a safety risk to Mario Kart Bike riders, the equipment must still have power to work properly. Therefore, the long wires will be replaced with batteries. Multiple batteries will supply the DC voltage and current needed to power the equipment for six hours of constant use.  

**Speed Sensor:** The KY-032 Obstacle Avoidance Sensor must have a DC voltage between 3.3 V and 5 V to operate correctly. Likewise, the KY-032 Obstacle Avoidance Sensor must have a minimum of 20 mA of current to operate correctly. The Nano 33 BLE and Bluetooth module will operate correctly with the given voltage between 3.3 V and 5 V.  

**Steering Sensor:** The Potentiometer voltage must be the same as the analog input, so the voltage for the Potentiometer must be the same as the analog to digital converter (ADC), microcontroller, and Bluetooth module. The ADC has a maximum voltage of 5.5 V and a minimum of 0 V. The Nano Bluetooth module will operate correctly with the given voltage between 3.3 V and 5 V. During the fabrication of the new design, analysis will be performed to ensure that safety risks have been mitigated. Although the long wires will be replaced to mitigate the risk resulting from the potential trip hazard, analysis will be performed to ensure that the batteries are not inducing an unacceptable level of voltage or current onto the Mario Kart Bike frame, posing a potential safety risk to the rider.  

**Data Transfer Method:** To improve the physical design of the Mario Kart bike and clean up the exposed wiring to create a form that is more like commercial products, communication between the sensors and main RPi shall be wireless.

_Buildable Schematic:_     

The wiring schematics for the speed and steering sensors are provided in **Figures 1** and **2**. The schematics are also uploaded to the Capstone Design documentation folder. 

![image](https://user-images.githubusercontent.com/113309616/216878265-85b9dd64-0cbd-4305-849b-ddae6a2e561f.png)

**Figure 1.** Wiring Schematic for the Speed Sensor

 ![image](https://user-images.githubusercontent.com/113309616/216878290-5532345e-a4e5-4ac4-8371-c4b1a3d5df2e.png)

**Figure 2.** Wiring Schematic for the Steering Sensor

_Analysis:_ 

An analysis has been performed to ensure that the existing steering and speed sensors installed on the Mario Kart Bike perform to specification, meeting both the technical requirements and ethical constraints for user safety. The results of the analysis indicate that the sensors are adequate to meet the intended performance, including the enhanced resistance and trail ride features. After verifying the adequacy of the speed and steering sensors, a design was developed to add the convenience of wireless connectivity. To assist in the verification of wireless capability for the speed and steering sensors, schematics were developed to provide illustrations for visual analysis of the design, including a satisfactory, functional means of mounting the batteries needed to achieve the required voltage. Additionally, the use of mathematical calculations enabled the verification of the quantity of batteries needed to provide the required voltage range. Since a single D battery provides 1.5 V and 6.25 A, four batteries will provide 6 V and 6.25 A, which is sufficient voltage within the required range and the required current. Based on the datasheet, the maximum current used by the microcontroller, which powers the sensors, is 1 Ah. Therefore, four D batteries provide sufficient current to power each microcontroller using 1 Ah for six hours of constant use. The dimensions of the battery holders, measuring 5.5 inches (L) by 2.8 inches (w) by 1.2 inches (h), are small and compact, avoiding the trip hazard posed by the long wires installed on the previous version of the Mario Kart Bike. Additionally, zip ties will be used to neatly and securely mount the battery holder to the Mario Kart bike frame, further promoting the safety of the Mario Kart Bike rider.  

In regards to the Bluetooth connectivity of each sensor, selection of the steering sensor’s microcontroller was the first order of business. This sensor will work in conjunction with the ADS 1015 and Potentiometer as well as the left and right handle bar buttons on the bike. The Arduino brand was selected due to their microcontrollers being generally simple, effective, and inexpensive. From here, the power constraint was also addressed, as some Arduino microcontrollers surpass the 5 V limit while others are at 5 V exactly. The Arduino Nano 33 BLE was also selected. The 33 BLE is a low power microcontroller that has an integrated Bluetooth module utilizing the Bluetooth Low Energy (BLE) version. BLE is a variation of Bluetooth 4.0, sacrificing range of transmission (100 m to 50 m) and data throughput (2.1 to 0.7 Mbps to 0.27 Mbps) in exchange for low power consumption. The loss of range and data throughput are acceptable losses, due to the sensors being within 5 m of the master RPi and the throughput still being more than acceptable for the amount of data that will be transmitted. The Nano 33 BLE satisfies the very important power constraint, while also having little to no drawbacks in function. Another benefit of the 33 BLE is its size, as it is Arduino’s smallest board, measuring at 45 mm by 18 mm. Size is an important aspect due to the location of the microcontrollers being along the metal pipes of the bike. This small microcontroller will be out of the way and will be very easy to conceal in an effort to improve the design of the Mario Kart Bike. For the speed sensor’s microcontroller, another Nano 33 BLE was chosen. This microcontroller will be used in conjunction with the KY-032 infrared sensor in order to accurately measure the speed of the rear wheel. An infrared light (square wave at 38 kHz) emitted from the KY-032 will be sent out toward the rear flywheel, hitting reflective (Paint or Tape) equally distanced around the edge of the flywheel, and bounce back toward the KY-032 sensor, entering the IR detector (HS0038B). As the flywheel turns, the emitted light will bounce as it hits the reflective (Paint or Tape), creating a signal that can be manipulated mathematically to determine the angular speed of the bike tire. A document by Bud Ryerson [1] details more information about the KY-032 sensor. The author discusses how to properly use the device, primarily by using the enable pin. Due to the receiver quickly saturating when active, the enable pin should not be active for more than 2 ms at a time. 

Strobing of the receiver can be programmed by Team 4. Because the IR light is emitted at a frequency of 38 kHz, the receiver must be cycling at 76 kHz (as a minimum) to satisfy the Nyquist sampling rate that is programmed into the design, as previously stated. By determining the time between any two high readings and multiplying this time by the number of individual markings, the time required to perform each revolution of the flywheel can be calculated. This number can be converted to revolutions per second (or minute) in the flywheel. By using the gearing ratio between the flywheel and the bike tire, the current revolutions per second (or minute) at the bike tire can be calculated. This calculation will constantly update, taking place between each individual marking, in order to be as precise as possible. This calculated number will be transmitted via Bluetooth to the main RPi to be used for other functions.

Coding of the Bluetooth modules and their respective microcontrollers will be accomplished in the Arduino IDE. This text editing platform is specifically used to program and communicate with Arduino hardware. Code will be written in C++ or C, as our team has the most experience with this language. Designation of microcontrollers is important, with the sensor’s microcontrollers being peripheral, strictly sending data. The RPi housed in the main component box will be considered the central microcontroller, or master, mainly receiving data from the peripheral microcontrollers and potentially controlling them if necessary.

Bluetooth also uses a concept of profiles. Profiles are a specification for Bluetooth communication that basically create a set of rules that allow certain tasks to be accomplished. Our sensors will be strictly sending bit data to a central RPi, so the Serial Port Profile (SPP) will be used. This profile defines how to set up virtual serial ports and connect two Bluetooth enabled devices. As of now, the central RPi does not have a Bluetooth module, so one must be purchased for the purpose of providing Bluetooth connectivity. The HC-05 module seems to be the best fit, because it works as master or slave (flexible), is compatible with the Arduino Nano 33 BLE and BLE Sense, and supports the SPP Bluetooth profile.  

Once the analysis of the design was determined to be satisfactory using the schematic and mathematical calculations, the materials needed to implement the new design of the speed and steering sensors were priced. The most economical purchasing option for the batteries was selected to ensure adequate quantities for the initial testing, standard use, and spares. The price for these materials was reviewed against the proposed budget and determined to be within range. To further promote safety, proper disposal of batteries drained of power will be performed by wrapping electrical tape on both ends of each battery to ensure that an object does not make a connection between the positive and negative ends of the battery, resulting in a fire during disposal.  

_BOM:_ 

The bill of materials (BOM) to accomplish the design illustrated in the schematics is provided in **Table 1**. 

**Table 1.** Bill of Materials
| Brand / Manufacturer       | Part Name              | Supplier | Part / Model # or ASIN # | Qty | Units  | Unit Cost | Cost   |
| -------------------------- | ---------------------- | -------- | ------------------------ | --- | ------ | --------- | ------ |
| SDTC Tech                  | 4 D Battery Holders    | Amazon   | B08594HCR5               | 2   | Pieces | $4.45     | $8.90  |
| Duracell                   | 8 Pack D Battery       | Amazon   | B00164H4AI               | 3   | Pack   | $15.87    | $47.61 |
| HMROPE                     | 8 Inch Zip Ties        | Amazon   | TXLAC                    | 1   | Pack   | $9.18     | $9.18  |
| Duck                       | Electrical Tape        | Amazon   | 282289                   | 1   | Roll   | $1.48     | $1.48  |
| Arduino                    | Nano 33 BLE            | Arduino  | ABX00030                 | 2   | Pieces | $26.30    | $52.60 |
| HiLetgo                    | HC-05 Bluetooth Module | Amazon   | B071YJG8DR               | 1   | Pieces | $10.39    | $10.39 |


**References**

[1]	_IR sensor for obstacle avoidance KY-032 (AD-032)_. IR Senor Obstacle Avoidance Keyes KY 032. (n.d.). Retrieved February 5, 2023, from http://irsensor.wizecode.com/ 
